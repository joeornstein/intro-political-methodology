---
title: "Problem Set 8 (Answer Key)"
author: "Joe Ornstein"
format: pdf
editor: visual

message: false
warning: false
---

## Problem 1

Perhaps there's still a backdoor path through education. Countries with a more educated population may be more democratic and less corrupt on average, biasing estimate of the effect of democracy on corruption. I downloaded data on the primary school completion rate by country [here](https://data.worldbank.org/indicator/SE.PRM.CMPT.ZS).

First, let's load and join the data

```{r}
library(tidyverse)
library(here)
library(countrycode)

d <- read_csv( here('data/week-09/corruption-data.csv') )

d

education <- read_csv( here('data/week-09/API_SE.PRM.CMPT.ZS_DS2_en_csv_v2_4685031.csv'),
                       skip = 4) |> 
  select(iso3 = `Country Code`,
         primary_education = `2019`)

education

d <- left_join(d, education, by = 'iso3')

d
```

Notice how I used the `skip = 4` option, since the data doesn't start until after the first 4 rows of that spreadsheet.

The estimated effect of democracy on corruption *without* conditioning on education was:

```{r}
lm(cpi_score ~ democracy + gdp_per_capita, data = d)
```

Now, conditioning on education:

```{r}
lm(cpi_score ~ democracy + gdp_per_capita + primary_education, data = d)
```

This suggests that (conditional on GDP per capita), education was not confounding the observed relationship between democracy and corruption.

## Problem 2

Let's load the wallet data and, keep only the wallets left at public institutions, and summarize each country's wallet return rate compared to its democratic history.

```{r}
cohn <- read_csv( here('data/cohn-2019/behavioral data (csv file).csv'))

d <- cohn |> 
  # keep only the wallets left at public institutions
  filter(public == 1) |> 
  group_by(Country) |> 
  summarize(wallet_return_rate = mean(response),
            years_democracy = mean(c_PIV_years_democracy))

library(ggrepel)

ggplot(data = d,
       mapping = aes(x = years_democracy,
                     y = wallet_return_rate,
                     label = Country)) +
  geom_text_repel() +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  theme_classic() +
  labs(x = 'Years Democracy',
       y = 'Wallet Return Rate')

lm(wallet_return_rate ~ years_democracy, data = d)
```

For each extra year as a democracy, the average wallet return rate increases roughly 0.27 percentage points. But we can't interpret this as causal without doing additional work! We measured the two variables differently, but there are still a large number of potential back door paths that could be confounding the relationship between democracy and public-sector wallet stealing.

## Problem 3

First, compute the wallet return rate in each country by treatment condition.

```{r}
d <- cohn |> 
  # keep just the Money and No Money conditions
  filter(cond %in% c(0,1)) |> 
  # relabel those conditions as "Money" and "NoMoney"
  mutate(cond = case_when(cond == 1 ~ 'Money',
                          cond == 0 ~ 'NoMoney')) |>
  # compute reporting rate by country and treatment condition
  group_by(Country, cond) |>
  summarize(pct_reported = mean(response)) |> 
  ungroup()

d
```

Next, it's useful to *pivot*Â the data so that each column represents the return rate for a treatment condition.

```{r}
d <- d |> 
  pivot_wider(names_from = cond, 
              values_from = pct_reported)

d
```

Then plot it, using the `geom_point()` and `geom_segment()` aesthetics.

```{r}
# begin ggplot
ggplot(data = d) +
  # red points for the Money condition
  geom_point(mapping = aes(x=Money, y=Country), 
             color = 'red') +
  # yellow points for the NoMoney Condition
  geom_point(mapping = aes(x=NoMoney, y=Country), 
             color = '#F6BE00') +
  # a gray line segment in between them
  geom_segment(mapping = aes(x=Money, xend=NoMoney, 
                             y=Country, yend=Country),
               color = 'gray', size = 0.5) +
  labs(x = 'Reporting rate (%)', y = '', color = 'Condition') +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank())
```

They're all out of order and they don't have those nice floating labels. We can fix that like so:

```{r}
d <- d |> 
  # reorder Country by the NoMoney reporting rate
  mutate(Country = fct_reorder(Country, NoMoney)) |>
  # compute label position, a bit left of the minimum reporting rate
  mutate(label_position = 
           pmin(Money, NoMoney) - nchar(as.character(Country))/3.5 - 1)
  
# then ggplot, adding a geom_text() layer
# begin ggplot
ggplot(data = d) +
  # red points for the Money condition
  geom_point(mapping = aes(x=Money, y=Country), 
             color = 'red') +
  # yellow points for the NoMoney Condition
  geom_point(mapping = aes(x=NoMoney, y=Country), 
             color = '#F6BE00') +
  # a gray line segment in between them
  geom_segment(mapping = aes(x=Money, xend=NoMoney, 
                             y=Country, yend=Country),
               color = 'gray', size = 0.5) +
  labs(x = 'Reporting rate (%)', y = '', color = 'Condition') +
  theme_classic() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank()) +
  geom_text(mapping = aes(x=label_position, 
                          y=Country, 
                          label = Country), 
            size = 2)
```
