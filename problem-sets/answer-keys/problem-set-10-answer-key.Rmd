---
title: "Problem Set: Finding Front Doors (Answer Key)"
author: "Joe Ornstein"
date: "November 10, 2021"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Problem 1: Heterogeneous Wallet Returns

First, load the wallet experiment data.

```{r}
library(tidyverse)
library(here)

wallets <- read_csv(here('data/cohn-2019/behavioral data (csv file).csv'))
```

Keep only the Money and No Money treatment conditions.

```{r}
wallets <- filter(wallets, cond %in% c(0,1))
```

Finally, estimate the average treatment effect for (a) men only, (b) women only, (c) public institutions only, and (d) people who understand what the experimenter is saying.

```{r}

# men
lm(response ~ cond, data = filter(wallets, male == 1))

# women
lm(response ~ cond, data = filter(wallets, male == 0))

# public institutions
lm(response ~ cond, data = filter(wallets, public == 1))

# respondents who understood the task
lm(response ~ cond, data = filter(wallets, understood_situation == 6))
```

That last one requires a judgment call. Does a 5 count as understanding? What about a 4? Your choice of cutoff may affect your result, and a thorough analysis should include some form of sensitivity analysis -- change your assumptions and see what happens to your conclusions.

What we're doing here is looking for **moderators**, variables that affect the magnitude of the treatment effect. We can still interpret these estimates as causal, because the treatment was randomized for everyone, regardless of subgroup. We don't condition on these variables to close back door paths; we condition on them to explore variation in the treatment effect.

By the way, you may recall another way to estimate moderating effects from our differential calculus problem set. Suppose you estimated a linear model like this:

$$\text{Return Wallet} = \beta_0 + \beta_1 \text{Money} + \beta_2 \text{Male} + \beta_3 \text{Money} \times \text{Male} + \varepsilon$$

Multiplying the Money and Male variables together represents an "interaction effect", where the slope with respect to Money depends on whether the respondent is male or female.

$$\frac{\partial \text{Return Wallet}}{\partial \text{Money}} = \beta_1 + \beta_3 \text{Male}$$

You can read that equation as saying that the effect of Money on returning wallets is $\beta_1$ for females and $\beta_1 + \beta_3$ for males

You can estimate this model in `R` by including a `*` between variables on the right hand side.

```{r}
lm(response ~ cond * male, data = wallets)
```

## Problem 2: Regression Discontinuity

First load the data.

```{r}
library(rdrobust)

raw <- read_csv(here('data/klasnja-titiunik-2017/KlasnjaTitiunik-LAcountries-data.csv'))
```

I'll get a little fancy here. Here's a function that takes the raw data plus a country name, and spits out the chart and regression discontinuity estimates. The nice thing about creating your own functions is that you don't have to copy and paste a bunch of code if you want to repeat some operation.

```{r}
estimate_incumbency_advantage <- function(raw_data, country_name){
  
  # filter just one country's elections
  d <- filter(raw_data, country == country_name)
  
  # plot the discontinuity
  p <- ggplot(data = filter(d, abs(mv_incumbent) < 30), 
       mapping = aes(x = mv_incumbent,
                     y = post_winning_incumbent_unc)) +
  stat_summary_bin(fun = 'mean', breaks = -100:100,
                   geom = 'point', shape = 'square') +
  geom_vline(xintercept = 0, color = 'red') +
  theme_classic() +
  labs(x = 'Incumbent Party Vote Margin at t',
       y = 'Probability of Unconditional Victory t+1',
       title = country_name)
  
  print(p)
  
  rdfit <- rdrobust(y = d$post_winning_incumbent_unc,
                  x = d$mv_incumbent,
                  c = 0)

  # return the estimated effect
  print(rdfit$coef['Robust',])
  
}


estimate_incumbency_advantage(raw, 'Brazil')
estimate_incumbency_advantage(raw, 'Chile')
estimate_incumbency_advantage(raw, 'Colombia')
estimate_incumbency_advantage(raw, 'Costa Rica')
estimate_incumbency_advantage(raw, 'Mexico')
estimate_incumbency_advantage(raw, 'Peru')
```